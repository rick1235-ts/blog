<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Di√°rio de Treino | Gera√ß√£o Alpha IA</title>
    <style>
        /* --- CONFIGURA√á√ÉO GLOBAL --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #121228; 
            --bg-card: #1f1f45; 
            --primary-neon: #00e0ff; 
            --secondary-neon: #76ff03; 
            --accent-glow: rgba(0, 224, 255, 0.6); 
            --text-light: #e6e6fa; 
            --border-dark: #353560;
            --danger-color: #ff4081; 
            --menu-bg: #18183a;
            --ia-color: #ffc300; 
            --rest-color: #f72585; 
        }

        body {
            font-family: 'Roboto Mono', monospace, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
        }
        
        .container {
            /* Adaptado para mobile: ocupa quase 100% da largura */
            width: 95%; 
            max-width: 1100px; 
            margin: 20px auto; 
            background: var(--bg-card);
            padding: 20px; 
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6), 0 0 15px var(--primary-neon);
            border: 1px solid var(--border-dark);
        }

        h1 {
            font-size: 1.8em; 
            margin-bottom: 20px;
        }

        h2, h3, h4 {
            font-size: 1.2em; 
            margin-top: 25px;
        }

        /* --- NAVEGA√á√ÉO / BOTOES --- */
        .nav-button {
            padding: 10px 15px;
            font-size: 0.8em; 
            flex-grow: 1; 
        }
        #nav-menu {
            display: flex; 
            justify-content: space-between;
            gap: 5px;
        }

        .btn {
            padding: 12px 15px;
            font-size: 0.9em;
        }
        .btn-rest {
            padding: 6px 10px;
            font-size: 0.8em;
        }

        /* --- CRON√îMETRO --- */
        #rest-timer-container {
            padding: 15px;
            position: static; 
            z-index: 1;
        }
        #rest-timer {
            font-size: 2em;
        }
        
        /* --- TABELAS RESPONSIVAS --- */
        #tabelaTreino, #tabelaHistorico {
            display: block; 
            width: 100%;
            overflow-x: auto; 
            white-space: nowrap; 
        }
        
        th, td {
            padding: 10px; 
            font-size: 0.8em; 
            white-space: nowrap;
        }
        
        #tabelaTreino th:nth-child(1) { width: 150px; } 
        #tabelaTreino th:nth-child(2) { width: 180px; } 
        #tabelaTreino th:nth-child(3) { width: 80px; } 
        #tabelaTreino th:nth-child(4) { width: 250px; } 
        #tabelaTreino th:nth-child(5) { width: 100px; } 
        
        /* Ajuste dos inputs na tabela (Corre√ß√£o para n√∫meros grandes) */
        .registro-input {
            width: 50px !important; 
            padding: 4px;
        }
        .registro-serie {
            gap: 3px;
        }

        /* --- IA/SUGEST√ÉO --- */
        .ia-suggestion {
            font-size: 0.75em; 
        }
        #ia-feedback-container {
            font-size: 0.9em;
        }

        /* Campos Adicionar Exerc√≠cio */
        #add-section .form-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Classes gerais de design */
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--secondary-neon); font-size: 0.9em; }
        input[type="text"], input[type="number"], .btn, select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--border-dark);
            background-color: var(--menu-bg);
            color: var(--text-light);
            box-sizing: border-box;
        }
        .btn-primary { background-color: var(--primary-neon); color: var(--bg-dark); font-weight: bold; border: none; }
        .btn-danger { background-color: var(--danger-color); color: white; border: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚ö° [ ALPHA G.Y.M. ] | IA TRAINER</h1>

        <div id="login-screen">
            <h2>üîë ACESSO AO SISTEMA | C√ìDIGO DE SEGURAN√áA</h2>
            <div class="form-group">
                <label for="codigoInput">CHAVE DE IDENTIFICA√á√ÉO:</label>
                <input type="text" id="codigoInput" placeholder="Ex: TREINOA (Rykelmy) ou TREINOB (Lu√≠sa)">
            </div>
            <button class="btn btn-primary" onclick="acessarTreino()">CONECTAR AO BANCO DE DADOS</button>
            <p id="mensagemErro"></p>
        </div>

        <div id="app-screen" style="display: none;">
            <h2 id="tituloTreino"></h2>

            <div id="rest-timer-container">
                <p id="rest-message">Tempo de Descanso Sugerido pela IA:</p>
                <div id="rest-timer">00:00</div>
                <button class="btn btn-rest" onclick="pararDescanso()">PULAR / ENCERRAR DESCANSO</button>
            </div>
            
            <div id="nav-menu">
                <button id="nav-registro" class="nav-button active" onclick="navegarPara('registro')">üèãÔ∏è REGISTRO</button>
                <button id="nav-add" class="nav-button" onclick="navegarPara('add')">‚ûï ADICIONAR</button>
                <button id="nav-historico" class="nav-button" onclick="navegarPara('historico')">üìã HIST√ìRICO</button>
            </div>
            
            <div id="registro-section" class="app-section">

                <div id="unit-selector-group">
                    <label for="unitSelector">Unidade de Medida:</label>
                    <select id="unitSelector" onchange="salvarUnidade()">
                        <option value="kg">Quilogramas (kg)</option>
                        <option value="lbs">Libras (lbs)</option>
                    </select>
                </div>
                
                <h3>[ FILTRO ] SELE√á√ÉO DE GRUPOS MUSCULARES</h3>
                <div id="grupoMuscularCheckboxes" class="checkbox-group">
                    </div>
                
                <h3 id="subTituloExercicios"></h3>
                
                <table id="tabelaTreino">
                    <thead>
                        <tr>
                            <th>EXERC√çCIO</th>
                            <th>S√âRIES/SUGEST√ÉO IA</th>
                            <th>PROGRESS√ÉO (<span id="progressUnit">kg</span> M√ÅX.)</th>
                            <th>REGISTRO DE S√âRIES</th>
                            <th style="width: 15%;">OP√á√ïES</th>
                        </tr>
                    </thead>
                    <tbody id="listaExercicios">
                        <tr><td colspan="5" style="text-align: center;">Selecione um grupo muscular acima para carregar o treino.</td></tr>
                    </tbody>
                </table>

                <div style="margin-top: 25px; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <button class="btn btn-primary" style="flex-grow: 1;" onclick="salvarTreino()">üíæ [ ENVIAR LOG ] SALVAR TREINO AGORA</button>
                    <button class="btn btn-danger" style="width: 35%;" onclick="logout()">[ DESCONECTAR ]</button>
                </div>
                <p id="mensagemSalvamento"></p>

                <div id="ia-feedback-container" style="display: none;">
                    <p id="ia-feedback-text"></p>
                </div>
            </div>


            <div id="add-section" class="app-section">
                <div id="add-exercise-form">
                    <h4>CRIAR NOVO ITEM AO PLANO</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newExName">NOME DO EXERC√çCIO:</label>
                            <input type="text" id="newExName" placeholder="Ex: Agachamento B√∫lgaro">
                        </div>
                        <div class="form-group">
                            <label for="newExGroup">GRUPO MUSCULAR (TAG):</label>
                            <input type="text" id="newExGroup" placeholder="Ex: Pernas">
                        </div>
                        <div class="form-group">
                            <label for="newExSeries">S√âRIES/REPETI√á√ïES PADR√ÉO:</label>
                            <input type="text" id="newExSeries" placeholder="Ex: 3x12 ou 4x8-10">
                        </div>
                    </div>
                    <button class="btn btn-primary table-btn" style="width: auto;" onclick="adicionarExercicioCustomizado()">[ SALVAR DEFINI√á√ÉO ]</button>
                    <p id="mensagemAdicao" style="margin-top: 10px;"></p>
                </div>
            </div>

            
            <div id="historico-section" class="app-section">
                <h3>üìÖ LOGS DE TREINOS ANTERIORES | DATABASE</h3>
                
                <table id="tabelaHistorico">
                    <thead>
                        <tr>
                            <th style="width: 30%;">DATA DO LOG</th>
                            <th style="width: 70%;">A√á√ÉO</th>
                        </tr>
                    </thead>
                    <tbody id="listaHistorico">
                        </tbody>
                </table>

                <div id="historico-detalhe" style="display: none;">
                    </div>
            </div>

        </div>
    </div>

    <script>
        const LOCAL_PLAN_KEY_PREFIX = "base_plan_";
        const HISTORICO_KEY_PREFIX = "historico_";
        const UNIT_KEY = "unidade_medida"; 
        let timerInterval;

        // --- Mapeamento de Tempo de Descanso por Grupo Muscular (IA) ---
        const TEMPO_DESCANSO_IA = {
            'Pernas': 120, 'Costas': 90, 'Peito': 90, 'Ombro': 60, 'B√≠ceps': 60, 'Tr√≠ceps': 60, 'Panturrilha': 45, 'Custom': 75
        };

        // --- Mapeamento de G√™nero (IA) ---
        const ALUNOS_GENERO = {
            'Rykelmy': 'M',
            'Lu√≠sa': 'F'
        };

        // --- DADOS MOCKADOS (Planos Base Iniciais) ---
        const TREINOS_PRONTOS_INICIAIS = [
            {
                codigo: "TREINOA", aluno: "Rykelmy", nome: "Plano Completo",
                exercicios: [
                    { nome: "Puxada na frente", grupo: "Costas", series_padrao: "4x10-12" },
                    { nome: "Remada baixa", grupo: "Costas", series_padrao: "4x10-12" },
                    { nome: "Remada curvada", grupo: "Costas", series_padrao: "3x8-10" },
                    { nome: "Pullover na corda", grupo: "Costas", series_padrao: "3x12-15" },
                    { nome: "Rosca direta", grupo: "B√≠ceps", series_padrao: "4x10-12" },
                    { nome: "Rosca alternada", grupo: "B√≠ceps", series_padrao: "3x10-12" },
                    { nome: "Rosca martelo", grupo: "B√≠ceps", series_padrao: "3x10-12" },
                    { nome: "Supino reto", grupo: "Peito", series_padrao: "4x8-12" },
                    { nome: "Supino inclinado", grupo: "Peito", series_padrao: "3x10-12" },
                    { nome: "Crucifixo", grupo: "Peito", series_padrao: "3x12-15" },
                    { nome: "Voador", grupo: "Peito", series_padrao: "3x12-15" },
                    { nome: "Agachamento livre", grupo: "Pernas", series_padrao: "4x8-12" },
                    { nome: "Leg press", grupo: "Pernas", series_padrao: "4x10-15" },
                    { nome: "Extensora", grupo: "Pernas", series_padrao: "3x12-15" },
                    { nome: "Flexora", grupo: "Pernas", series_padrao: "3x12-15" },
                    { nome: "Panturrilha", grupo: "Pernas", series_padrao: "4x15-20" }
                ]
            },
            {
                codigo: "TREINOB", aluno: "Lu√≠sa", nome: "Foco: Pernas e Ombro",
                exercicios: [
                    { nome: "Agachamento Livre", grupo: "Pernas", series_padrao: "4x8" },
                    { nome: "Leg Press", grupo: "Pernas", series_padrao: "3x12" },
                    { nome: "Eleva√ß√£o Lateral", grupo: "Ombro", series_padrao: "3x15" },
                    { nome: "Cadeira Extensora", grupo: "Pernas", series_padrao: "3x15" }
                ]
            }
        ];

        let treinoAtual = null;

        // --- FUN√á√ïES DE UNIDADE DE MEDIDA ---

        function getUnidade() {
            return localStorage.getItem(UNIT_KEY) || 'kg';
        }

        function salvarUnidade() {
            const unidade = document.getElementById('unitSelector').value;
            localStorage.setItem(UNIT_KEY, unidade);
            
            document.getElementById('progressUnit').textContent = unidade;
            filtrarExercicios();
        }


        // --- FUN√á√ïES DO CRON√îMETRO DE DESCANSO INTELIGENTE ---
        
        function iniciarDescanso(grupoMuscular) {
            const tempoSegundos = TEMPO_DESCANSO_IA[grupoMuscular] || TEMPO_DESCANSO_IA['Custom'];
            let segundosRestantes = tempoSegundos;

            document.getElementById('rest-timer-container').style.display = 'block';
            document.getElementById('rest-message').textContent = `[IA] ${grupoMuscular} em Foco. Descanso Sugerido: ${tempoSegundos} segundos.`;
            document.getElementById('rest-timer').textContent = formatarTempo(segundosRestantes);

            clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                segundosRestantes--;
                document.getElementById('rest-timer').textContent = formatarTempo(segundosRestantes);

                if (segundosRestantes <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('rest-timer').textContent = "00:00";
                    document.getElementById('rest-message').innerHTML = `<strong>[ALERTA] TEMPO ESGOTADO!</strong> Pr√≥xima s√©rie!`;
                }
            }, 1000);
        }

        function pararDescanso() {
            clearInterval(timerInterval);
            document.getElementById('rest-timer-container').style.display = 'none';
        }

        function formatarTempo(totalSegundos) {
            const minutos = Math.floor(totalSegundos / 60);
            const segundos = totalSegundos % 60;
            return `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        }
        
        // --- FUN√á√ÉO DE NAVEGA√á√ÉO CENTRALIZADA ---
        function navegarPara(secao) {
            pararDescanso(); 
            
            const secoes = ['registro', 'add', 'historico'];
            const navButtons = document.querySelectorAll('.nav-button');

            secoes.forEach(id => {
                const elemento = document.getElementById(id + '-section');
                const navBtn = document.getElementById('nav-' + id);
                
                if (id === secao) {
                    elemento.style.display = 'block';
                    navBtn.classList.add('active');
                    
                    if (secao === 'historico') {
                        carregarListaHistorico();
                    }
                    if (secao === 'registro') {
                        filtrarExercicios();
                    }
                } else {
                    elemento.style.display = 'none';
                    navBtn.classList.remove('active');
                }
            });
        }


        // --- FUN√á√ïES DE INICIALIZA√á√ÉO E CONTROLE DE TELA ---

        function init() {
            const codigoSalvo = sessionStorage.getItem('codigoTreino');
            
            const unidadeAtual = getUnidade();
            const unitSelector = document.getElementById('unitSelector');
            if (unitSelector) unitSelector.value = unidadeAtual;
            const progressUnit = document.getElementById('progressUnit');
            if (progressUnit) progressUnit.textContent = unidadeAtual;


            if (codigoSalvo) {
                document.getElementById('codigoInput').value = codigoSalvo;
                acessarTreino(codigoSalvo);
            } else {
                document.getElementById('app-screen').style.display = 'none';
            }
        }

        function acessarTreino(codigoPreenchido) {
            const codigo = codigoPreenchido || document.getElementById('codigoInput').value.toUpperCase().trim();
            
            const localPlanKey = LOCAL_PLAN_KEY_PREFIX + codigo;
            const planoPersonalizado = localStorage.getItem(localPlanKey);

            let treinoEncontrado;

            if (planoPersonalizado) {
                treinoEncontrado = JSON.parse(planoPersonalizado);
            } else {
                treinoEncontrado = TREINOS_PRONTOS_INICIAIS.find(t => t.codigo === codigo);
            }

            if (treinoEncontrado) {
                treinoAtual = treinoEncontrado;
                sessionStorage.setItem('codigoTreino', codigo); 
                
                document.getElementById('mensagemErro').textContent = '';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                
                document.getElementById('tituloTreino').textContent = `[ STATUS: ONLINE ] Ol√°, ${treinoAtual.aluno}! Plano Ativo: ${treinoAtual.nome}`;
                
                carregarFiltros();
                navegarPara('registro');
                
            } else {
                document.getElementById('mensagemErro').textContent = '‚ùå [ ERRO 404 ] C√≥digo de acesso inv√°lido.';
                treinoAtual = null;
            }
        }

        function logout() {
            pararDescanso();
            sessionStorage.removeItem('codigoTreino');
            treinoAtual = null;
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('codigoInput').value = '';
            document.getElementById('listaExercicios').innerHTML = '<tr><td colspan="5" style="text-align: center;">Aguardando Conex√£o...</td></tr>'; 
            document.getElementById('mensagemSalvamento').textContent = '';
            document.getElementById('subTituloExercicios').textContent = '';
            document.getElementById('ia-feedback-container').style.display = 'none';
        }

        function getHistorico() {
            const chave = HISTORICO_KEY_PREFIX + treinoAtual.codigo;
            const historicoJSON = localStorage.getItem(chave);
            return historicoJSON ? JSON.parse(historicoJSON) : [];
        }


        // --- FUN√á√ïES DE FILTRAGEM E RENDERIZA√á√ÉO ---

        function carregarFiltros() {
            const container = document.getElementById('grupoMuscularCheckboxes');
            container.innerHTML = '';
            
            const grupos = [...new Set(treinoAtual.exercicios.map(ex => ex.grupo))].sort(); 
            
            grupos.forEach(grupo => {
                const id = `check-${grupo.replace(/\s/g, '')}`; 
                container.innerHTML += `
                    <input type="checkbox" id="${id}" value="${grupo}" onchange="filtrarExercicios()">
                    <label for="${id}">${grupo}</label>
                `;
            });
            document.getElementById('subTituloExercicios').textContent = '[ LISTA ] Selecione os grupos para ver o treino.';
        }

        function filtrarExercicios() {
            const checkboxes = document.querySelectorAll('#grupoMuscularCheckboxes input:checked');
            const gruposSelecionados = Array.from(checkboxes).map(cb => cb.value);

            const exerciciosFiltrados = treinoAtual.exercicios.filter(ex => 
                gruposSelecionados.includes(ex.grupo)
            );
            
            if (gruposSelecionados.length === 0) {
                 document.getElementById('subTituloExercicios').textContent = '[ STATUS ] Selecione os grupos para exibir a lista.';
            } else {
                document.getElementById('subTituloExercicios').textContent = `[ ATIVO ] Grupos: ${gruposSelecionados.join(', ')}`;
            }

            renderizarExercicios(exerciciosFiltrados);
        }

        // IA - Sugest√£o de Carga (Aprimorada com G√™nero e Humor)
        function getProgressoExercicio(nomeExercicio, historico, grupoMuscular) {
            let cargaMaxima = 0;
            let ultimaCarga = 0; 
            let sugestao = '';
            const tempoDescanso = TEMPO_DESCANSO_IA[grupoMuscular] || TEMPO_DESCANSO_IA['Custom'];
            const genero = ALUNOS_GENERO[treinoAtual.aluno] || 'M';
            const unidade = getUnidade();

            for (const treino of historico) {
                const ex = treino.exercicios.find(e => e.nome === nomeExercicio);
                if (ex && ex.registro.length > 0) {
                    const maxCargaTreino = Math.max(...ex.registro.map(s => s.carga));
                    
                    cargaMaxima = Math.max(cargaMaxima, maxCargaTreino);

                    ultimaCarga = ex.registro[ex.registro.length - 1].carga; 
                }
            }
            
            // L√≥gica de Feedback da IA
            if (cargaMaxima > 0) {
                if (ultimaCarga > cargaMaxima) { 
                    sugestao = `[IA]: üöÄ RECORDE PESSOAL: ${ultimaCarga}${unidade}! Mantenha essa energia. Descanso: ${tempoDescanso}s.`;
                } else if (ultimaCarga === cargaMaxima) {
                    if (genero === 'M') {
                        sugestao = `[IA]: Peso igual ao m√°ximo. Aumenta esse peso, franguinho! Sugest√£o: ${cargaMaxima + 1}${unidade}.`;
                    } else { 
                        sugestao = `[IA]: Peso mantido! Se a execu√ß√£o foi f√°cil, ${cargaMaxima + 1}${unidade} te espera. Descanso: ${tempoDescanso}s.`;
                    }
                } else if (ultimaCarga < cargaMaxima * 0.9) {
                    if (genero === 'M') {
                         sugestao = `[IA]: ${ultimaCarga}${unidade} √© pouco. Lembra da for√ßa? Volta para ${cargaMaxima}${unidade}. Descanso: ${tempoDescanso}s.`;
                    } else {
                         sugestao = `[IA]: Aten√ß√£o, carga abaixo do normal. Tente voltar para ${cargaMaxima}${unidade}. Descanso: ${tempoDescanso}s.`;
                    }
                } else {
                    sugestao = `[IA]: √öltimo registro: ${ultimaCarga}${unidade}. Foco na cad√™ncia. Descanso: ${tempoDescanso}s.`;
                }
            } else {
                 sugestao = `[IA]: Primeira carga. Mostre-me sua for√ßa! Descanso sugerido: ${tempoDescanso}s.`;
            }


            return {
                texto: cargaMaxima > 0 ? `${cargaMaxima} ${unidade}` : '[ NOVO ]',
                ultimaCarga: ultimaCarga,
                sugestao: sugestao
            };
        }

        function renderizarExercicios(exercicios) {
            const lista = document.getElementById('listaExercicios');
            const historico = getHistorico();
            const unidade = getUnidade();
            lista.innerHTML = ''; 
            
            if (exercicios.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light);">Nenhum exerc√≠cio selecionado ou encontrado no filtro.</td></tr>';
                return;
            }

            exercicios.forEach((ex, index) => {
                const progresso = getProgressoExercicio(ex.nome, historico, ex.grupo); 
                
                const numSeriesMatch = ex.series_padrao.match(/^(\d+)/);
                const numSeries = numSeriesMatch ? parseInt(numSeriesMatch[1]) : 3;

                let seriesInputs = '';
                for(let i = 1; i <= numSeries; i++) {
                    const repsPattern = ex.series_padrao.split('x')[1];
                    const repsPadrao = repsPattern ? repsPattern.split('-')[0].trim() : 12;

                    seriesInputs += `
                        <div class="registro-serie">
                            S${i}: 
                            <input type="number" placeholder="${repsPadrao}" class="registro-input" data-ex-index="${index}" data-serie="${i}" data-tipo="reps" value="${repsPadrao}">
                            x
                            <input type="number" placeholder="Carga" class="registro-input" data-ex-index="${index}" data-serie="${i}" data-tipo="carga" value="${progresso.ultimaCarga || ''}"> ${unidade}
                        </div>
                    `;
                }
                
                const progressoClass = progresso.texto === '[ NOVO ]' ? 'novo-ex' : 'progresso-texto';

                lista.innerHTML += `
                    <tr class="fade-in"> 
                        <td><strong style="color: var(--primary-neon);">${ex.nome}</strong> (${ex.grupo})</td>
                        <td>
                            <div style="font-size: 1.1em; font-weight: bold;">${ex.series_padrao}</div>
                            <span class="ia-suggestion">${progresso.sugestao}</span> 
                            <button class="btn btn-rest table-btn" style="margin-top: 5px;" 
                                onclick="iniciarDescanso('${ex.grupo}')">
                                ‚è±Ô∏è DESCANSO IA
                            </button>
                        </td>
                        <td class="${progressoClass}">${progresso.texto}</td>
                        <td><div class="registro-container">${seriesInputs}</div></td>
                        <td>
                            <button class="btn btn-danger table-btn" 
                                onclick="removerExercicioDoPlano('${ex.nome}')">
                                üóëÔ∏è REMOVER
                            </button>
                        </td>
                    </tr>
                `;
            });
        }


        // --- NOVO: IA - Feedback P√≥s-Treino com Frases Aleat√≥rias ---

        function gerarFeedbackIA(exerciciosDoTreino) {
            const gruposTreinados = [...new Set(exerciciosDoTreino.map(ex => ex.grupo))];
            let progressoAtingido = 0;
            let totalExercicios = exerciciosDoTreino.length;

            const excelenteFrases = [
                "Desempenho **EXCELENTE**! Foco e esfor√ßo m√°ximo detectados. Voc√™ est√° no caminho da **Hipertrofia Otimizada**.",
                "N√≠vel de for√ßa atingido: **SUPERIOR**! Voc√™ triturou este treino. Sem mimimi, s√≥ resultados.",
                "Resultado **IMPEC√ÅVEL**! A m√°quina est√° respondendo. Continue com essa intensidade de elite, parab√©ns!",
                "LOG PERFEITO! A performance foi m√°xima. N√£o h√° como melhorar, apenas manter o ritmo e aumentar a carga.",
                "An√°lise final: **PERFORMANCE ALFA**! Sua sess√£o foi de alta qualidade e totalmente documentada. O ganho √© inevit√°vel!",
                "Voc√™ superou a vers√£o anterior de si mesmo(a). Sua progress√£o est√° agressiva e precisa. N√≠vel de motiva√ß√£o: 100%!",
                "Treino validado pela IA! Cada repeti√ß√£o e carga contaram. Voc√™ executou o plano com maestria. Pr√≥ximo desafio √© na balan√ßa!",
                "Miss√£o completa com sucesso! O sistema registra zero falhas de registro. Seu corpo vai agradecer este n√≠vel de dedica√ß√£o."
            ];

            const bomFrases = [
                "Desempenho **BOM**. A maioria dos exerc√≠cios foi registrada. Mantenha o foco no tempo de descanso sugerido pela IA.",
                "Atingiu a meta! A base est√° s√≥lida! O pr√≥ximo passo √© buscar a falha em pelo menos uma s√©rie a mais.",
                "Sess√£o s√≥lida e consistente! Lembre-se, consist√™ncia √© a chave. Vamos tentar aumentar a carga em 2-3 exerc√≠cios na pr√≥xima vez.",
                "Treino OK! N√£o foi o melhor, mas foi feito. Na pr√≥xima, vamos com tudo! Foco!",
                "O motor est√° aquecendo! Quase l√° na performance m√°xima. Na pr√≥xima vez, feche 100% dos registros. Isso √© importante!",
                "Potencial de crescimento alto. Seu esfor√ßo √© not√°vel, mas h√° margem para mais carga ou menos descanso. Vamos otimizar!",
                "A m√©dia foi positiva! Bom trabalho. Agora, use os dados hist√≥ricos para bater aquele peso m√°ximo que voc√™ deixou para tr√°s.",
                "O registro est√° quase completo. Da pr√≥xima vez, n√£o deixe nenhum exerc√≠cio sem log. Cada detalhe conta para a IA te ajudar."
            ];

            const moderadoFrases = [
                "Desempenho **MODERADO**. Reveja a frequ√™ncia ou a distribui√ß√£o de energia na sess√£o. Precisamos de mais empenho.",
                "Poderia ter sido melhor. Vamos aumentar a concentra√ß√£o e a intensidade na pr√≥xima vez para evitar desperd√≠cio de tempo.",
                "Falta de registro de carga em muitas s√©ries. N√£o deixe o treino na m√£o da sorte, registre tudo para a IA te ajudar.",
                "Aten√ß√£o ao REGISTRO! Muitos buracos nas cargas. Tente registrar ao final de cada exerc√≠cio. Sua progress√£o depende disso.",
                "Metade do caminho n√£o √© o bastante! Use o cron√¥metro IA e a sugest√£o de peso para elevar o n√≠vel na pr√≥xima sess√£o.",
                "O comprometimento com o registro de dados caiu. Lembre-se: se n√£o est√° no log, n√£o aconteceu. Volte ao topo!",
                "O foco estava inst√°vel. Recarregue as energias e volte mais forte. Cada treino √© uma nova oportunidade para ser melhor.",
                "O sistema detecta que o potencial n√£o foi totalmente explorado. Analise os exerc√≠cios perdidos e garanta o registro completo."
            ];


            exerciciosDoTreino.forEach(ex => {
                const maxCargaSessao = Math.max(...ex.registro.map(r => r.carga));
                if (maxCargaSessao > 0) {
                    progressoAtingido++;
                }
            });

            if (totalExercicios === 0) {
                return "N√£o h√° dados para analisar. Registre pelo menos uma s√©rie.";
            }

            const porcentagem = (progressoAtingido / totalExercicios) * 100;
            let fraseAleatoria;
            
            if (porcentagem > 90) {
                fraseAleatoria = getRandomPhrase(excelenteFrases);
            } else if (porcentagem > 60) {
                fraseAleatoria = getRandomPhrase(bomFrases);
            } else {
                fraseAleatoria = getRandomPhrase(moderadoFrases);
            }
            
            let feedback = `${fraseAleatoria}`;
            feedback += `<br>Grupos Focados: ${gruposTreinados.join(', ')}.`;
            
            return feedback;
        }


        // --- FUN√á√ÉO DE SALVAMENTO (LOGICA PRINCIPAL) ---

        function salvarTreino() {
            pararDescanso();
            
            const historico = getHistorico();
            const exerciciosDoTreino = [];
            
            const data = new Date();
            const dataAtual = data.getFullYear() + '-' + String(data.getMonth() + 1).padStart(2, '0') + '-' + String(data.getDate()).padStart(2, '0');

            const linhasTabela = document.querySelectorAll('#listaExercicios tr');
            
            linhasTabela.forEach(linha => {
                const nomeElement = linha.querySelector('td strong');
                if (!nomeElement) return;

                const nomeCompleto = nomeElement.textContent.trim();
                const nomeExercicio = nomeCompleto.split('(')[0].trim();
                const matchGrupo = nomeCompleto.match(/\(([^)]+)\)/);
                const grupoMuscular = matchGrupo ? matchGrupo[1] : 'Desconhecido';
                
                const inputsReps = linha.querySelectorAll('[data-tipo="reps"]');
                const inputsCarga = linha.querySelectorAll('[data-tipo="carga"]');
                
                const registroExercicio = [];

                inputsReps.forEach((inputReps, i) => {
                    const cargaInput = inputsCarga[i];
                    const reps = parseInt(inputReps.value) || 0;
                    const carga = parseFloat(cargaInput.value) || 0;

                    if (reps > 0 || carga > 0) {
                        registroExercicio.push({ reps, carga });
                    }
                });

                if (registroExercicio.length > 0) {
                    exerciciosDoTreino.push({
                        nome: nomeExercicio,
                        registro: registroExercicio,
                        grupo: grupoMuscular
                    });
                }
            });

            if (exerciciosDoTreino.length === 0) {
                document.getElementById('mensagemSalvamento').innerHTML = '[ ALERTA ] Nenhum registro de treino enviado. Preencha as s√©ries.';
                document.getElementById('ia-feedback-container').style.display = 'none'; 
                return;
            }

            const historicoFiltrado = historico.filter(reg => reg.data !== dataAtual);

            const novoRegistro = {
                data: dataAtual,
                exercicios: exerciciosDoTreino
            };

            historicoFiltrado.push(novoRegistro);
            
            const chave = HISTORICO_KEY_PREFIX + treinoAtual.codigo;
            localStorage.setItem(chave, JSON.stringify(historicoFiltrado));
            
            // 1. Gera o feedback da IA
            const feedbackIA = gerarFeedbackIA(exerciciosDoTreino);

            // 2. Exibe o feedback na tela
            document.getElementById('ia-feedback-text').innerHTML = `<strong>[IA] An√°lise Conclu√≠da:</strong> ${feedbackIA}`;
            document.getElementById('ia-feedback-container').style.display = 'block';

            document.getElementById('mensagemSalvamento').innerHTML = `[ LOG ENVIADO ] Treino de ${new Date(dataAtual).toLocaleDateString('pt-BR')} salvo. Progress√£o de carga atualizada.`;
            
            filtrarExercicios();
        }

        // --- FUN√á√ïES DE MANUTEN√á√ÉO (Demais fun√ß√µes) ---
        function getRandomPhrase(phrases) {
            const randomIndex = Math.floor(Math.random() * phrases.length);
            return phrases[randomIndex];
        }

        function adicionarExercicioCustomizado() {
            const nome = document.getElementById('newExName').value.trim();
            const grupo = document.getElementById('newExGroup').value.trim();
            const series = document.getElementById('newExSeries').value.trim();
            const msg = document.getElementById('mensagemAdicao');

            if (!nome || !grupo || !series) {
                msg.innerHTML = '<span style="color: var(--danger-color); font-weight: bold;">[ ALERTA ] Por favor, preencha todos os campos.</span>';
                return;
            }

            const novoExercicio = {
                nome: nome,
                grupo: grupo,
                series_padrao: series
            };

            if (treinoAtual.exercicios.some(ex => ex.nome.toUpperCase() === nome.toUpperCase())) {
                msg.innerHTML = '<span style="color: var(--danger-color); font-weight: bold;">[ ALERTA ] Exerc√≠cio j√° existe no plano.</span>';
                return;
            }
            
            treinoAtual.exercicios.push(novoExercicio);
            salvarPlanoBase();

            document.getElementById('newExName').value = '';
            document.getElementById('newExGroup').value = '';
            document.getElementById('newExSeries').value = '';

            msg.innerHTML = '<span style="color: var(--secondary-neon); font-weight: bold;">[ OK ] Item adicionado. V√° para REGISTRO DE TREINO para usar.</span>';
            
            carregarFiltros();
        }

        function removerExercicioDoPlano(nomeExercicio) {
            if (!confirm(`[ CONFIRMA√á√ÉO ] Deseja realmente remover "${nomeExercicio}" do seu plano?`)) {
                return;
            }

            treinoAtual.exercicios = treinoAtual.exercicios.filter(ex => ex.nome !== nomeExercicio);

            salvarPlanoBase();
            
            carregarFiltros();
            filtrarExercicios();
            alert(`[ OK ] "${nomeExercicio}" removido com sucesso.`);
        }

        function salvarPlanoBase() {
            const localPlanKey = LOCAL_PLAN_KEY_PREFIX + treinoAtual.codigo;
            localStorage.setItem(localPlanKey, JSON.stringify(treinoAtual));
        }
        
        function carregarListaHistorico() {
            const historico = getHistorico();
            const lista = document.getElementById('listaHistorico');
            lista.innerHTML = '';
            document.getElementById('historico-detalhe').style.display = 'none';

            if (historico.length === 0) {
                lista.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--danger-color);">[ LOG ] Nenhuma entrada de treino encontrada.</td></tr>';
                return;
            }

            historico.reverse().forEach((treino, index) => {
                const dataFormatada = new Date(treino.data).toLocaleDateString('pt-BR');
                lista.innerHTML += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>
                            <button class="btn btn-primary table-btn" onclick="exibirDetalheTreino('${treino.data}')">
                                [ VER DETALHES ]
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function exibirDetalheTreino(data) {
            const historico = getHistorico();
            const treino = historico.find(t => t.data === data);
            const detalheDiv = document.getElementById('historico-detalhe');
            let conteudo = '';

            if (treino) {
                conteudo += `<h4>LOG do Treino em: ${new Date(treino.data).toLocaleDateString('pt-BR')}</h4>`;
                conteudo += '<ul>';

                const unidade = getUnidade();
                treino.exercicios.forEach(ex => {
                    const seriesTexto = ex.registro.map(s => `${s.reps} rep. @ ${s.carga} ${unidade}`).join(' | ');
                    conteudo += `<li><strong style="color: var(--primary-neon);">${ex.nome}:</strong> ${seriesTexto}</li>`;
                });

                conteudo += '</ul>';
                detalheDiv.innerHTML = conteudo;
                detalheDiv.style.display = 'block';
            }
        }

        // Inicializa o app ao carregar a p√°gina
        window.onload = init;
    </script>
</body>
</html>
